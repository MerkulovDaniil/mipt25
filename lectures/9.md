---
title: "Двухфазный симплекс-метод. Двойственность в ЛП"
author: Даниил Меркулов
institute: Методы оптимизации. МФТИ
format: 
    beamer:
        pdf-engine: xelatex
        aspectratio: 169
        fontsize: 9pt
        section-titles: true
        incremental: true
        include-in-header: ../files/xeheader.tex  # Custom LaTeX commands and preamble
header-includes:
  - \newcommand{\bgimage}{../files/back11.jpeg}
---


# Двойственность в линейном программировании

## Двойственность

:::: {.columns}

::: {.column width="50%"}
Прямая задача:

$$
\begin{split}
&\min_{x \in \mathbb{R}^n} c^{\top}x \\
\text{s.t. } & Ax = b\\
& x_i \geq 0, \; i = 1,\dots, n
\end{split}
$$ {#eq-lp_primal}

. . .

ККТ для оптимальных $x^*, \nu^*, \lambda^*$:
$$
\begin{split}
&L(x, \nu, \lambda) = c^Tx + \nu^T(Ax-b) - \lambda^T x \\
&-A^T \nu^* + \lambda^* = c \\
&Ax^* = b\\
&x^*\succeq 0\\
&\lambda^*\succeq 0\\
&\lambda^*_i x_i^* = 0\\
\end{split}
$$

:::

. . .

::: {.column width="50%"}
Имеет следующую двойственную:

$$
\begin{split}
&\max_{\nu \in \mathbb{R}^m} -b^{\top}\nu \\
\text{s.t. } & -A^T\nu \preceq c\\
\end{split}
$$ {#eq-lp_dual}

Найдите двойственную задачу к задаче выше (она должна быть исходной задаче ЛП). Также запишите условия ККТ для двойственной задачи, чтобы убедиться, что они идентичны условиям ККТ для прямой задачи.
:::

::::

## Сильная двойственность в линейном программировании

:::{callout-theorem}
(i) Если любая из задач @eq-lp_primal или @eq-lp_dual имеет (конечное) решение, то и другая имеет, и значения целевых функций равны.

(ii) Если любая из задач @eq-lp_primal или @eq-lp_dual неограничена, то другая задача недопустима.
:::

. . .

**ДОКАЗАТЕЛЬСТВО.** Для (i) предположим, что @eq-lp_primal имеет конечное оптимальное решение $x^*$. Из ККТ следует, что существуют оптимальные векторы $\lambda^*$ и $\nu^*$ такие, что $(x^*, \nu^*, \lambda^*)$ удовлетворяет ККТ. Мы отметили выше, что ККТ для @eq-lp_primal и @eq-lp_dual эквивалентны. Более того, как утверждалось, $c^Tx^* = (-A^T \nu^* + \lambda^*)^T x^* = - (\nu^*)^T A x^* =  - b^T\nu^*$.

Симметричный аргумент справедлив, если мы начнем с предположения, что двойственная задача @eq-lp_dual имеет решение.

. . .

Чтобы доказать (ii), предположим, что прямая задача неограничена, то есть существует последовательность точек $x_k$, $k = 1,2,3,\ldots$ такая, что
$$
c^Tx_k \downarrow -\infty, \quad Ax_k = b, \quad x_k \geq 0.
$$

. . .

Предположим также, что двойственная задача @eq-lp_dual допустима, то есть существует вектор $\bar{\nu}$ такой, что $-A^T \bar{\nu} \leq c$. Из последнего неравенства вместе с $x_k \geq 0$ имеем, что $-\bar{\nu}^T Ax_k \leq c^T x_k$, и поэтому 
$$
-\bar{\nu}^T b = -\bar{\nu}^T Ax_k \leq c^T x_k \downarrow -\infty,
$$
что приводит к противоречию. Следовательно, двойственная задача должна быть недопустимой. Аналогичный аргумент можно использовать, чтобы показать, что неограниченность двойственной задачи влечет недопустимость прямой.

# Максимальный поток - минимальный разрез

## Задача максимального потока

:::: {.columns align=top}

::: {.column width="40%"}
![](maxflow.pdf){align-vertical="top"}

Узлы — это маршрутизаторы, рёбра — это каналы связи; с каждым узлом связана пропускная способность — узел 1 может передавать узлу 2 до 6 Мбит/с, узел 2 может передавать узлу 4 до 2 Мбит/с и т.д.
:::

. . .

::: {.column width="60%"}
**Вопрос:**

* Сеть узлов и рёбер представляет каналы связи, каждый с указанной пропускной способностью.
* Пример: Может ли узел 1 (источник) передавать узлу 6 (сток) со скоростью 6 Мбит/с? 12 Мбит/с? Какова максимальная скорость?

. . .

**Матрица пропускной способности:**
$$
C = 
\begin{bmatrix}
0 & 6 & 0 & 0 & 6 & 0 \\
0 & 0 & 2 & 2 & 0 & 0 \\
0 & 0 & 0 & 2 & 0 & 7 \\
0 & 0 & 0 & 0 & 0 & 3 \\
0 & 0 & 0 & 5 & 0 & 2 \\
0 & 0 & 0 & 0 & 0 & 0
\end{bmatrix}
$$

. . .

**Матрица потока:** $X[i,j]$ представляет поток от узла $i$ к узлу $j$.

. . .

**Ограничения:**
$$
0 \preceq X \qquad  X \preceq C
$$
$$
\text{Сохранение потока: } \sum_{j=2}^N X(i,j) = \sum_{k=1}^{N-1} X(k,i), \; i = 2, \dots, N-1
$$
:::
::::

## Задача максимального потока {.noframenumbering}

:::: {.columns align=top}

::: {.column width="40%"}
![](maxflow.pdf)

При данной настройке, когда всё, что производится источником, пойдёт к стоку, поток сети — это просто сумма всего, что выходит из источника:

$$\tag{Поток}
\sum_{i=2}^N X(1, i)
$$
:::

. . .

::: {.column width="60%"}

$$\tag{Задача максимального потока}
\begin{aligned}
\text{max } & \langle X, S\rangle \\
\text{s.t. } -X &\preceq 0 \\
 X &\preceq C \\
\langle X, L_n\rangle &= 0, \; n = 2, \dots, N-1,
\end{aligned}
$$

$L_n$ составляется как вычитание двух матриц. Обе матрицы почти полностью состоят из нулей. Только в первой матрице $n$-ый столбец состоит из единиц (кроме последней строки). А во второй матрице только $n$-ая строка состоит из единиц (кроме первого столбца).
$$
S =
\begin{bmatrix}
0 & 1 & \cdots & 1 \\
0 & 0 & \cdots & 0 \\
\vdots & \vdots & \ddots & \vdots \\
0 & 0 & \cdots & 0
\end{bmatrix}, \quad
L_2 =
\begin{bmatrix}
0 & 1 & 0 & \cdots & 0 \\
0 & 0 & -1 & \cdots & -1 \\
0 & 1 & 0 & \cdots & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 1 & 0 & \cdots & 0 \\
0 & 0 & 0 & \cdots & 0
\end{bmatrix}.
$$

:::
::::

## Вывод двойственной задачи к максимальному потоку

. . .

$$\tag{Двойственная задача максимального потока}
\begin{aligned}
\text{min } & \langle \Lambda, C\rangle \\
\Lambda, \nu & \\
\text{s.t. } \Lambda + Q &\succeq S \\
 \Lambda &\succeq 0
\end{aligned}
$${#eq-maxflow_dual}

где
$$
Q =
\begin{bmatrix}
0 & \nu_2 & \nu_3 & \cdots & \nu_{N-1} & 0 \\
0 & 0 & \nu_3 - \nu_2 & \cdots & \nu_{N-1} - \nu_2 & -\nu_2 \\
0 & \nu_2 - \nu_3 & 0 & \cdots & \nu_{N-1} - \nu_3 & -\nu_3 \\
\vdots & \vdots & \vdots & \ddots & \vdots & \vdots \\
0 & \nu_2 - \nu_{N-1} & \nu_3 - \nu_{N-1} & \cdots & 0 & -\nu_{N-1} \\
0 & 0 & 0 & \cdots & 0 & 0
\end{bmatrix}.
$$


## Задача минимального разреза

Разрез сети разделяет вершины на два множества: одно содержит источник (мы называем это множество $\mathcal{S}$), а другое содержит сток. Пропускная способность разреза — это общее значение рёбер, выходящих из $\mathcal{S}$ — мы разделяем множества, "отрезая поток" вдоль этих рёбер.

:::: {.columns align=top}

::: {.column width="50%"}
![](mincut1.pdf){width=80%}

Рёбра в разрезе: $1\to 2, 4 \to 6$, и $5 \to 6$, пропускная способность этого разреза равна $6 + 3 + 2 = 11$.

:::
::: {.column width="50%"}
![](mincut2.pdf){width=80%}

Рёбра в разрезе: $2\to3, 4 \to 6$, и $5 \to 6$, пропускная способность этого разреза равна $2 + 3 + 2 = 7$.

:::
::::

## Минимальный разрез является двойственным к максимальному потоку

Каково минимальное значение наименьшего разреза? Мы докажем, что оно равно оптимальному значению решения $d^*$ двойственной программы ([-@eq-maxflow_dual]).

. . .

Сначала предположим, что $\mathcal{S}$ — допустимый разрез. Из $\mathcal{S}$ мы можем легко найти двойственную допустимую точку, которая соответствует его пропускной способности: для $n = 1, \ldots , N$ возьмём
$$
\nu_n =
\begin{cases}
1, & n \in \mathcal{S}, \\
0, & n \notin \mathcal{S},
\end{cases}
\qquad \text{и} \qquad
\lambda_{i,j} =
\begin{cases}
\max(\nu_i - \nu_j, 0), & i \neq 1, \, j \neq N, \\
1 - \nu_j, & i = 1, \\
\nu_i, & j = N.
\end{cases}
$$

. . .

Заметим, что эти выборы подчиняются ограничениям в двойственной задаче, и что
$\lambda_{i,j}$ будет равен 1, если $i \to j$ разрезан, и 0 в противном случае, поэтому
$$
\text{capacity}(S) = \sum_{i,j} \lambda_{i,j} C_{i,j}.
$$

. . .

Каждый разрез допустим, поэтому
$$
d^\star \leq \text{MINCUT}.
$$

## Минимальный разрез является двойственным к максимальному потоку

Теперь мы покажем, что для каждого решения $\nu^*, \lambda^*$ двойственной задачи существует разрез с пропускной способностью не более $d^*$. Мы генерируем разрез \textit{случайно}, а затем показываем, что ожидаемое значение пропускной способности разреза меньше $d^*$ — это означает, что должен существовать хотя бы один с пропускной способностью $d^*$ или меньше.

. . .

Пусть $Z$ — равномерная случайная величина на $[0, 1]$. Вместе с $\lambda^*, \nu_2^*, \dots, \nu_{N-1}^*$, полученными решением ([-@eq-maxflow_dual]), возьмём $\nu_1 = 1$ и $\nu_N = 0$. Создадим разрез $\mathcal{S}$ по правилу:
$$
\text{если } \nu_n^* > Z, \text{ то возьмём } n \in \mathcal{S}.
$$

. . .
Вероятность того, что конкретное ребро $i \to j$ находится в этом разрезе, равна
$$
\begin{aligned}
P(i \in \mathcal{S}, j \notin \mathcal{S}) &= P\left(\nu_j^\star \leq Z \leq \nu_i^\star\right) \\
&\leq
\begin{cases}
\max(\nu_i^\star - \nu_j^\star, 0), & 2 \leq i, j \leq N - 1, \\
1 - \nu_j^\star, & i = 1; \, j = 2, \dots, N - 1, \\
\nu_i^\star, & i = 2, \dots, N - 1; \, j = N, \\
1, & i = 1; \, j = N.
\end{cases} \\
&\leq \lambda_{i,j}^\star,
\end{aligned}
$$

## Минимальный разрез является двойственным к максимальному потоку

Последнее неравенство следует просто из ограничений в двойственной программе ([-@eq-maxflow_dual]). Этот разрез случайный, поэтому его пропускная способность — случайная величина, и её ожидание равно
$$
\begin{aligned}
\mathbb{E}[\text{capacity}(\mathcal{S})] &= \sum_{i,j} C_{i,j} P(i \in \mathcal{S}, j \notin \mathcal{S}) \\
&\leq \sum_{i,j} C_{i,j} \lambda_{i,j}^\star = d^\star.
\end{aligned}
$$

. . .

Таким образом, должен существовать разрез, пропускная способность которого не более $d^\star$. Это устанавливает, что
$$
\text{MINCUT} \leq d^\star.
$$

. . .

Объединяя эти два факта, конечно, получаем, что
$$
d^\star = \text{MINCUT} = \text{MAXFLOW} = p^\star,
$$
где $p^\star$ — решение прямой задачи, и равенство следует из сильной двойственности для линейного программирования.

. . .

:::{.callout-theorem}
### Теорема максимального потока — минимального разреза. 

Максимальное значение s-t потока равно минимальной пропускной способности среди всех s-t разрезов.
:::

# Анализ чувствительности

## Анализ чувствительности

:::: {.columns}

::: {.column width="50%"}

Давайте перейдём от исходной задачи оптимизации

$$
\begin{split}
& f_0(x) \to \min\limits_{x \in \mathbb{R}^n}\\
\text{s.t. } & f_i(x) \leq 0, \; i = 1,\ldots,m\\
& h_i(x) = 0, \; i = 1,\ldots, p
\end{split}
\tag{P}
$$

:::

. . .

::: {.column width="50%"}

К возмущённой версии:

$$
\begin{split}
& f_0(x) \to \min\limits_{x \in \mathbb{R}^n}\\
\text{s.t. } & f_i(x) \leq u_i, \; i = 1,\ldots,m\\
& h_i(x) = v_i, \; i = 1,\ldots, p
\end{split}
\tag{Per}
$$

:::
::::

. . .

Заметим, что у нас по-прежнему есть только переменная $x \in \mathbb{R}^n$, в то время как $u \in \mathbb{R}^m, v \in \mathbb{R}^p$ мы рассматриваем как параметры. Очевидно, что $\text{Per}(u,v) \to \text{P}$, если $u = 0, v = 0$. Мы будем обозначать оптимальное значение $\text{Per}$ как $p^*(u, v)$, в то время как оптимальное значение исходной задачи $\text{P}$ — просто $p^*$. Можно сразу сказать, что $p^*(u, v) = p^*$.

. . .

Говоря о значении некоторого $i$-го ограничения, можно сказать, что

* $u_i = 0$ оставляет исходную задачу
* $u_i > 0$ означает, что мы ослабили неравенство
* $u_i < 0$ означает, что мы ужесточили ограничение

. . .

Можно даже показать, что когда $\text{P}$ является задачей выпуклой оптимизации, $p^*(u,v)$ является выпуклой функцией.

## Анализ чувствительности

Предположим, что сильная двойственность выполняется для исходной задачи, и предположим, что $x$ — любая допустимая точка для возмущённой задачи:
$$
\begin{split}
\uncover<+->{p^*(0,0) &= p^* = d^* = g(\lambda^*, \nu^*) \leq \\}
\uncover<+->{& \leq L(x, \lambda^*, \nu^*) = \\}
\uncover<+->{& = f_0(x) + \sum\limits_{i=1}^m \lambda_i^* f_i(x) + \sum\limits_{i=1}^p\nu_i^* h_i(x) \leq \\}
\uncover<+->{& \leq f_0(x) + \sum\limits_{i=1}^m \lambda_i^* u_i + \sum\limits_{i=1}^p\nu_i^* v_i }
\end{split}
$$

. . .

Что означает
$$
\begin{split}
f_0(x) \geq p^*(0,0) - {\lambda^*}^T u - {\nu^*}^T v 
\end{split}
$$

. . .

И взяв оптимальную $x$ для возмущённой задачи, имеем:
$$
p^*(u,v) \geq p^*(0,0) - {\lambda^*}^T u - {\nu^*}^T v 
$$ {#eq-sensitivity}

## Анализ чувствительности

В сценариях, где выполняется сильная двойственность, мы можем сделать несколько выводов о чувствительности оптимальных решений по отношению к множителям Лагранжа. Эти выводы основаны на неравенстве, выраженном в уравнении выше:

* **Влияние ужесточения ограничения (большое $\lambda_i^\star$)**:  
   Когда множитель Лагранжа $i$-го ограничения, $\lambda_i^\star$, имеет существенное значение, и если это ограничение ужесточается (выбирается $u_i < 0$), гарантируется, что оптимальное значение, обозначенное $p^\star(u, v)$, значительно увеличится.

* **Эффект корректировки ограничений с большими положительными или отрицательными $\nu_i^\star$**:  
   - Если $\nu_i^\star$ велик и положителен, и выбирается $v_i < 0$, или  
   - Если $\nu_i^\star$ велик и отрицателен, и выбирается $v_i > 0$,  
   то в любом сценарии ожидается, что оптимальное значение $p^\star(u, v)$ значительно увеличится.

* **Последствия ослабления ограничения (малое $\lambda_i^\star$)**:  
   Если множитель Лагранжа $\lambda_i^\star$ для $i$-го ограничения относительно мал, и ограничение ослабляется (выбирается $u_i > 0$), ожидается, что оптимальное значение $p^\star(u, v)$ не значительно уменьшится.

* **Результаты крошечных корректировок в ограничениях с малыми $\nu_i^\star$**:  
   - Когда $\nu_i^\star$ мал и положителен, и выбирается $v_i > 0$, или  
   - Когда $\nu_i^\star$ мал и отрицателен, и выбирается $v_i < 0$,  
   в обоих случаях оптимальное значение $p^\star(u, v)$ не значительно уменьшится.

. . .

Эти интерпретации предоставляют основу для понимания того, как изменения в ограничениях, отражённые через соответствующие множители Лагранжа, влияют на оптимальное решение в задачах, где выполняется сильная двойственность.

## Локальная чувствительность

:::: {.columns}

::: {.column width="50%"}

Предположим теперь, что $p^*(u, v)$ дифференцируема в точке $u = 0, v = 0$. 

. . .

$$
\lambda_i^* = -\dfrac{\partial p^*(0,0)}{\partial u_i} \quad \nu_i^* = -\dfrac{\partial p^*(0,0)}{\partial v_i}
$$ {#eq-local-sensitivity}

. . .

Чтобы показать этот результат, мы рассматриваем направленную производную $p^*(u,v)$ вдоль направления некоторого $i$-го базисного вектора $e_i$:

. . .

$$
\lim_{t \to 0} \dfrac{p^*(t e_i,0) - p^*(0,0)}{t} = \dfrac{\partial p^*(0,0)}{\partial u_i}
$$

. . .

Из неравенства @eq-sensitivity и взяв предел $t \to0$ с $t>0$, имеем

. . .

$$
\dfrac{p^*(t e_i,0) - p^*}{t} \geq -\lambda_i^* \to  \dfrac{\partial p^*(0,0)}{\partial u_i} \geq -\lambda_i^*
$$

. . .

Для отрицательного $t < 0$ имеем:

. . .

$$
\dfrac{p^*(t e_i,0) - p^*}{t} \leq -\lambda_i^* \to  \dfrac{\partial p^*(0,0)}{\partial u_i} \leq -\lambda_i^*
$$

:::

. . .

::: {.column width="50%"}

Та же идея может быть использована для установления факта о $v_i$. 

. . .

Результат локальной чувствительности @eq-local-sensitivity предоставляет способ понять влияние ограничений на оптимальное решение $x^*$ задачи оптимизации. Если ограничение $f_i(x^*)$ отрицательно в $x^*$, оно не влияет на оптимальное решение, что означает, что небольшие изменения в этом ограничении не изменят оптимальное значение. В этом случае соответствующий оптимальный множитель Лагранжа будет равен нулю, согласно принципу дополнительной нежёсткости. 

. . .

Однако, если $f_i(x^*) = 0$, что означает, что ограничение точно выполняется в оптимуме, то ситуация иная. Значение $i$-го оптимального множителя Лагранжа, $\lambda^*_i$, даёт нам понимание того, насколько "чувствительно" или "активно" это ограничение. Малое $\lambda^*_i$ указывает на то, что небольшие корректировки ограничения не будут значительно влиять на оптимальное значение. Наоборот, большое $\lambda^*_i$ подразумевает, что даже незначительные изменения ограничения могут иметь значительное влияние на оптимальное решение.

:::

::::


## Источники

* [Теория оптимизации (MATH4230) курс @ CUHK, professor Tieyong Zeng](https://www.math.cuhk.edu.hk/course_builder/1920/math4230/Lagrangeduality-example.pdf)