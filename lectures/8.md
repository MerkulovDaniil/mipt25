---
title: "Условия оптимальности. Функция Лагранжа. Условия Каруша-Куна-Таккера"
author: Даня Меркулов
institute: Методы оптимизации. МФТИ
format: 
    beamer:
        pdf-engine: xelatex
        aspectratio: 169
        fontsize: 9pt
        section-titles: true
        incremental: true
        include-in-header: ../files/xeheader.tex  # Custom LaTeX commands and preamble
header-includes:
  - \newcommand{\bgimage}{../files/back8.jpeg}
---



:::: {.columns}
::: {.column width="65%"}
> В этой работе совершенно отсутствуют какие бы то ни было чертежи. Излагаемые мною методы не требуют ни построений, ни геометрических или механических рассуждений; они требуют только алгебраических операций, подчиненных планомерному и однообразному алгоритму. 

---*Предисловие к "Аналитической механике"*
:::

::: {.column width="35%"}
![Жозеф Луи Лагранж](lagrange.jpg)
:::

::::

# Задачи с ограничениями-неравенствами

## Пример задачи с ограничениями-неравенствами

$$
f(x) = x_1^2 + x_2^2 \;\;\;\; g(x) = x_1^2 + x_2^2 - 1
$$

$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_1_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_2_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_3_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_4_ru.pdf)

## Задачи с ограничениями-неравенствами

Таким образом, если ограничения типа неравенства неактивны в условной задаче, то мы можем решать задачу без ограничений. Однако так бывает не всегда. Рассмотрим второй простой пример.
$$
f(x) = (x_1 - 1)^2 + (x_2 + 1)^2 \;\;\;\; g(x) = x_1^2 + x_2^2 - 1
$$

$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_5_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_6_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_7_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_8_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_9_ru.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_10.pdf)

## Задачи с ограничениями-неравенствами

![Иллюстрация ККТ (случай неравенства)](ineq_constr_11_ru.pdf)

## Задачи с ограничениями-неравенствами

Итак, у нас есть задача:
$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$
Два возможных случая:

:::: {.columns}

::: {.column width="40%"}
$g(x) \leq 0$ неактивно: $g(x^*) < 0$

* $g(x^*) < 0$
* $\nabla f(x^*) = 0$
* $\nabla^2 f(x^*) \succ 0$

:::

. . .

::: {.column width="60%"}
$g(x) \leq 0$ активно: $g(x^*) = 0$

* $g(x^*) = 0$
* Необходимые условия: $- \nabla f(x^*) = \lambda \nabla g(x^*)$, $\lambda > 0$
* Достаточные условия: $\langle y, \nabla^2_{xx} L(x^*, \lambda^*) y \rangle > 0, \forall y \neq 0 \in \mathbb{R}^n : \nabla g(x^*)^\top y = 0$
:::

::::


## Лагранжиан для задач с ограничениями-неравенствами

:::: {.columns}

::: {.column width="35%"}

Объединяя два возможных случая, мы можем записать общие условия для задачи:
$$
\begin{split}
& f(x) \to \min\limits_{x \in \mathbb{R}^n} \\
\text{s.t. } & g(x) \leq 0
\end{split}
$$
Определим функцию Лагранжа:
$$
L(x, \lambda) = f(x) + \lambda g(x)
$$
Классические условия Каруша-Куна-Таккера для локального минимума $x^*$, сформулированные при некоторых условиях регулярности, можно записать следующим образом.

:::

. . .

::: {.column width="65%"}

Если $x^*$ является локальным минимумом для описанной выше задачи, то существует единственный множитель Лагранжа $\lambda^*$ такой, что:
$$
\begin{split}
& (1) \; \nabla_x L (x^*, \lambda^*) = 0\\
& (2) \; \lambda^* \geq 0\\
& (3) \; \lambda^* g(x^*) = 0\\
& (4) \; g(x^*) \leq 0\\
& (5) \; \forall y \in C(x^*):  \langle y , \nabla^2_{xx} L(x^*, \lambda^*) y \rangle > 0 \\
&  \text{where } C(x^*) = \{y \ \in \mathbb{R}^n |  \nabla f(x^*)^\top y \leq 0 \text{ and } \forall i \in I(x^*):  \nabla g_i(x^*)^T y \leq 0 \} \text{ is the critical cone.} \\
& I(x^*) = \{i \mid g_i(x^*) = 0\}
\end{split}
$$

:::
::::

# KKT

## Общая формулировка

$$
\begin{split}
& f_0(x) \to \min\limits_{x \in \mathbb{R}^n}\\
\text{s.t. } & f_i(x) \leq 0, \; i = 1,\ldots,m\\
& h_i(x) = 0, \; i = 1,\ldots, p
\end{split}
$$
Данная формулировка является общей задачей математического программирования. 

Решение включает в себя построение лагранжиана: 
$$
L(x, \lambda, \nu) = f_0(x) + \sum\limits_{i=1}^m \lambda_i f_i(x) + \sum\limits_{i=1}^p\nu_i h_i(x)
$$

## Необходимые условия
Пусть $x^*$, $(\lambda^*, \nu^*)$ является решением __регулярной__ задачи математического программирования _с нулевым зазором двойственности (оптимальное значение для исходной задачи $p^*$ равно оптимальному значению для двойственной задачи $d^*$)_. Пусть также функции $f_0, f_i, h_i$ дифференцируемы.

* $\nabla_x L(x^*, \lambda^*, \nu^*) = 0$
* $\nabla_\nu L(x^*, \lambda^*, \nu^*) = 0$
* $\lambda^*_i \geq 0, i = 1,\ldots,m$
* $\lambda^*_i f_i(x^*) = 0, i = 1,\ldots,m$
* $f_i(x^*) \leq 0, i = 1,\ldots,m$

## Некоторые условия регулярности
Эти условия нужны для того, чтобы условия Каруша-Куна-Таккера стали необходимыми условиями. Некоторые из них даже превращают необходимые условия в достаточные (например, условие Слейтера). 
Кроме того, если у нас есть регулярность, мы можем записать необходимые условия второго порядка $\langle y, \nabla^2_{xx} L(x^*, \lambda^*, \nu^*) y \rangle \geq 0$ с *полуопределенным* гессианом лагранжиана.

* **Условие Слейтера.** Если для выпуклой задачи (при минимизации, с выпуклыми $f_0, f_{i}$ и аффинными $h_{i}$) существует точка $x$ такая, что $h(x) = 0$ и $f_{i}(x) < 0$ (существует строго допустимая точка), то зазор двойственности равен нулю, и условия Каруша—Куна—Таккера становятся необходимыми и достаточными.
* **Условие линейной квалификации ограничений.** Если $f_{i}$ и $h_{i}$ являются аффинными функциями, то никаких других условий не требуется.
* **Условие линейной независимости ограничений.** Градиенты активных ограничений неравенства и градиенты ограничений равенства линейно независимы в точке $x^*$.  
* Для других примеров см. [wiki](https://en.wikipedia.org/wiki/Karush%E2%80%93Kuhn%E2%80%93Tucker_conditions#Regularity_conditions_(or_constraint_qualifications)).

## Доказательство в простом случае

:::{.callout-theorem}

## Субдифференциальная форма ККТ

Пусть $X$ - линейное нормированное пространство, а $f_j: X \to \mathbb{R}$, $j = 0, 1, \ldots, m$ - выпуклая и не принимающая значения$-\infty$ и $\infty$. Рассмотрим задачу
$$
\begin{split}
& f_0(x) \to \min\limits_{x \in X}\\
\text{s.t. } & f_j(x) \leq 0, \; j = 1,\ldots,m\\
\end{split}
$$
Пусть $x^* \in X$ - точка минимума, и функции $f_j$, $j = 0, 1, \ldots, m$, непрерывны в $x^*$. Тогда существуют $\lambda_j \geq 0$, $j = 0, 1, \ldots, m$ такие, что
$$
\sum_{j=0}^{m} \lambda_j = 1,
$$
$$
\lambda_j f_j(x^*) = 0, \quad j = 1, \ldots, m,
$$
$$
0 \in \sum_{j=0}^{m} \lambda_j \partial f_j(x^*).
$$

:::

## Доказательство в простом случае

::::{.columns}

::: {.column width="50%"}

**Доказательство**

1. Рассмотрим функцию

    $$
    f(x) = \max\{f_0(x) - f_0(x^*), f_1(x), \ldots, f_m(x)\}.
    $$

    Точка $x^*$ - точка глобального минимума этой функции. Действительно, если в некоторой точке $x_e \in X$ выполнено неравенство $f(x_e) < 0$, то $f_0(x_e) < f_0(x^*)$ и $f_j(x_e) < 0$, $j = 1, \ldots, m$, что противоречит тому, что точка $x^*$ является точкой минимума. 

2. Из теоремы Ферма в субдифференциальной форме

    $$
    0 \in \partial f(x^*).
    $$

:::
::: {.column width="50%"}

3. Из теоремы Дубовицкого-Милютина имеем

    $$
    \partial f(x^*) = \text{conv } \left( \bigcup\limits_{j \in I}\partial f_j(x^*)\right),
    $$

    где $I = \{0\} \cup \{j : f_j(x^*) = 0, 1 \leq j \leq m\}$. 

4. Следовательно, существует $g_j \in \partial f_j(x^*)$, $j \in I$ такая, что

    $$
    \sum_{j \in I} \lambda_j g_j = 0, \quad \sum\limits_{j \in I}\lambda_j = 1, \quad \lambda_j \geq 0, \quad j \in I.
    $$

   Осталось установить $\lambda_j = 0$ for $j \notin I$.
:::
::::



## Пример. Проекция на гиперплоскость

$$
\min_{\mathbf x \in \mathbb{R}^n} \frac{1}{2}\|\mathbf{x} - \mathbf{y}\|^2, \quad \text{s.t.} \quad \mathbf{a}^T\mathbf{x} = b.
$$

. . .

**Решение**

Лагранжиан:

. . .

$$
L(\mathbf{x}, \nu) = \frac{1}{2}\|\mathbf{x} - \mathbf{y}\|^2 + \nu(\mathbf{a}^T\mathbf{x} - b)
$$

. . .

Производная $L$ по $\mathbf{x}$:
$$
\frac{\partial L}{\partial \mathbf{x}} = \mathbf{x} - \mathbf{y} + \nu\mathbf{a} = 0, \qquad \mathbf{x} = \mathbf{y} - \nu\mathbf{a}
$$

. . .

$$
\mathbf{a}^T\mathbf{x} = \mathbf{a}^T\mathbf{y} - \nu\mathbf{a}^T\mathbf{a} \qquad \nu = \dfrac{\mathbf{a}^T\mathbf{y} - b}{\|\mathbf{a}\|^2}
$$

. . .

$$
\mathbf{x} = \mathbf{y} - \dfrac{\mathbf{a}^T\mathbf{y} - b}{\|\mathbf{a}\|^2}\mathbf{a}
$$


## Пример. Проекция на единичный симплекс

$$
\min_{\mathbf x \in \mathbb{R}^n} \frac{1}{2} \lVert \mathbf x - \mathbf y \rVert^2, \quad \text{s.t.} \quad \mathbf x^\top \mathbf 1 = 1, \quad \mathbf x \geq 0.
$$

. . .

#### Условия ККТ

Лагранжиан задается следующим образом:
$$
L = \frac{1}{2} \lVert \mathbf x - \mathbf y \rVert^2 - \sum_i \lambda_i x_i + \nu (\mathbf x^\top \mathbf 1 - 1)
$$

. . .

Взяв производную $L$ по $x_i$ и записав ККТ, мы получаем:

* $\frac{\partial L}{\partial x_i} = x_i - y_i - \lambda_i + \nu = 0$
* $\lambda_i x_i = 0$
* $\lambda_i \geq 0$
* $\mathbf x^\top \mathbf 1 = 1, \quad \mathbf x \geq 0$

. . .

::::{.columns}

::: {.column width="50%"}

:::{.callout-question}
Решите систему выше за $O(n \log n)$.
:::
:::

. . .

::: {.column width="50%"}
:::{.callout-question}
Решите систему выше за $O(n)$.
:::
:::
::::

## Ссылки
* [Лекция](http://www.csc.kth.se/utbildning/kth/kurser/DD3364/Lectures/KKT.pdf) по условиям ККТ (очень интуитивное объяснение) в курсе "Элементы статистического обучения" @ KTH.
* [Однострочное доказательство ККТ](https://link.springer.com/content/pdf/10.1007%2Fs11590-008-0096-3.pdf)
* [О втором порядке оптимальности для задач оптимизации с ограничениями неравенства](https://www.scirp.org/pdf/OJOp_2013120315191950.pdf)
* [О втором порядке оптимальности в нелинейной оптимизации](https://www.ime.usp.br/~ghaeser/secondorder.pdf)
* [Численная оптимизация](https://www.math.uci.edu/~qnie/Publications/NumericalOptimization.pdf) by Jorge Nocedal and Stephen J. Wright. 